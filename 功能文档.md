# Vue项目国际化(i18n)自动转换工具 - 功能文档

## 1. 项目概述

### 1.1 项目背景
本工具旨在帮助大型Vue项目快速引入i18n国际化支持，通过自动化方式提取项目中的中文文本，减少手动迁移的工作量。

### 1.2 技术栈
- Node.js
- 文件系统操作(fs)
- AST语法树解析(@babel/parser, vue-template-compiler)

### 1.3 项目结构
```
i18n-tool/                    # 转换工具项目
├── src/
│   ├── index.js             # 主入口
│   ├── parser/              # 解析器模块
│   ├── extractor/           # 提取器模块
│   └── generator/           # 生成器模块
├── config.json              # 配置文件
├── output/                  # 输出目录
└── package.json

target-project/               # 待转换的Vue项目
```

## 2. 核心功能

### 2.1 中文文本识别与提取

#### 2.1.1 识别范围
- **.vue文件**
  - `<template>` 区域的文本内容
  - `<script>` 区域的字符串字面量
  - 属性值中的中文文本
  
- **.js/.ts文件**
  - 字符串字面量中的中文
  - 对象属性值中的中文
  - 函数调用参数中的中文

#### 2.1.2 中文识别规则
- 匹配包含中文字符的字符串 (正则: `/[\u4e00-\u9fa5]+/`)
- 支持纯中文字符串
- 支持中英文混合字符串
- 支持包含标点符号的中文文本

### 2.2 模板字符串处理

#### 2.2.1 识别模板字符串
识别以下类型的模板字符串：
```javascript
// JavaScript模板字符串
`欢迎${username}登录`

// Vue插值表达式
"用户名：{{username}}"
```

#### 2.2.2 特殊标记
- 包含变量的模板字符串会被标记为 `__TEMPLATE__`
- 在输出JSON中单独分组便于手动处理
- 记录变量占位符信息

### 2.3 JSON输出格式

#### 2.3.1 基础结构
```json
{
  "normal": {
    "src/views/Home.vue::template::line:5": "首页",
    "src/views/Home.vue::script::line:12": "欢迎使用",
    "src/utils/message.js::line:8": "操作成功"
  },
  "templates": {
    "src/views/User.vue::template::line:15": {
      "original": "欢迎${username}登录",
      "type": "__TEMPLATE__",
      "variables": ["username"]
    },
    "src/components/Table.vue::script::line:23": {
      "original": "共{{total}}条记录",
      "type": "__TEMPLATE__",
      "variables": ["total"]
    }
  }
}
```

#### 2.3.2 Key命名规则
格式: `文件相对路径::区域::行号`
- 文件路径：相对于项目根目录
- 区域：template/script/style
- 行号：文本所在行号

### 2.4 配置文件

#### 2.4.1 config.json结构
```json
{
  "targetProject": "../target-project",
  "outputDir": "./output",
  "fileExtensions": [".vue", ".js", ".ts"],
  "excludeDirs": ["node_modules", "dist", ".git"],
  "excludeFiles": ["*.min.js", "*.test.js"],
  "encoding": "utf-8"
}
```

#### 2.4.2 配置项说明
- `targetProject`: 待转换项目路径
- `outputDir`: JSON文件输出目录
- `fileExtensions`: 需要扫描的文件类型
- `excludeDirs`: 排除的目录
- `excludeFiles`: 排除的文件模式
- `encoding`: 文件编码格式

## 3. 功能模块设计

### 3.1 文件扫描模块 (Scanner)
- 递归遍历目标项目目录
- 根据配置过滤文件和目录
- 返回需要处理的文件列表

### 3.2 解析模块 (Parser)
- **Vue文件解析器**
  - 使用 `vue-template-compiler` 解析 Vue 2 文件
  - 分离template、script、style区域
  
- **JavaScript解析器**
  - 使用 `@babel/parser` 生成AST
  - 遍历AST节点提取字符串

### 3.3 提取模块 (Extractor)
- 识别中文字符串
- 区分普通字符串和模板字符串
- 记录文件路径、行号、区域信息
- 生成唯一key

### 3.4 生成模块 (Generator)
- 将提取结果格式化为JSON
- 分组存储普通文本和模板文本
- 生成带时间戳的输出文件

### 3.5 替换模块 (Replacer)
- 根据JSON配置自动替换源文件中的中文
- 生成i18n函数调用
- 处理不同场景的替换策略
- 备份原始文件

### 3.6 i18n配置生成模块 (I18nGenerator)
- 生成i18n语言包文件(zh-CN.js, en-US.js等)
- 自动生成合理的key值
- 支持嵌套结构的配置文件
- 生成导入语句和初始化代码

## 4. 使用流程

### 4.1 安装依赖
```bash
cd i18n-tool
npm install
```

### 4.2 配置项目
编辑 `config.json` 设置目标项目路径

### 4.3 执行提取
```bash
npm start
```

### 4.4 查看结果
检查 `output/` 目录下生成的JSON文件

### 4.5 手动处理
- 处理 `templates` 分组中的模板字符串
- 转换为i18n格式的占位符
- 例: `欢迎${username}登录` → `$t('welcome', {username})`

## 5. 输出示例

### 5.1 普通文本
```json
{
  "src/views/Login.vue::template::line:10": "用户登录",
  "src/views/Login.vue::template::line:15": "用户名",
  "src/views/Login.vue::template::line:18": "密码"
}
```

### 5.2 模板文本
```json
{
  "src/components/UserInfo.vue::template::line:8": {
    "original": "欢迎回来，{{username}}",
    "type": "__TEMPLATE__",
    "variables": ["username"],
    "suggestion": "welcomeBack"
  }
}
```

## 6. 注意事项

### 6.1 处理建议
- 先处理普通文本的自动转换
- 模板字符串需要人工审核和处理
- 注意动态拼接的字符串可能需要重构

### 6.2 特殊情况
- 注释中的中文：可选是否提取
- HTML实体：需要特殊处理
- 正则表达式中的中文：建议排除
- v-html指令内容：需要特别标记

### 6.3 性能优化
- 大型项目分批处理
- 使用流式处理避免内存溢出
- 可添加进度条显示

## 7. 后续扩展

### 7.1 自动替换功能

#### 7.1.1 替换策略
**Vue Template区域**
```vue
<!-- 替换前 -->
<template>
  <div>
    <h1>用户管理</h1>
    <button>提交</button>
  </div>
</template>

<!-- 替换后 -->
<template>
  <div>
    <h1>{{ $t('userManagement') }}</h1>
    <button>{{ $t('submit') }}</button>
  </div>
</template>
```

**Vue Script区域**
```javascript
// 替换前
export default {
  data() {
    return {
      message: '操作成功'
    }
  }
}

// 替换后
export default {
  data() {
    return {
      message: this.$t('operationSuccess')
    }
  }
}
```

**JavaScript文件**
```javascript
// 替换前
const title = '首页标题';
console.log('加载完成');

// 替换后
import i18n from '@/i18n';
const title = i18n.t('homeTitle');
console.log(i18n.t('loadComplete'));
```

#### 7.1.2 生成i18n配置文件

**目录结构**
```
target-project/
└── src/
    └── i18n/
        ├── index.js           # i18n初始化文件
        └── locales/
            ├── zh-CN.js       # 中文语言包
            └── en-US.js       # 英文语言包(可选)
```

**zh-CN.js示例**
```javascript
export default {
  common: {
    submit: '提交',
    cancel: '取消',
    confirm: '确认'
  },
  user: {
    userManagement: '用户管理',
    username: '用户名',
    password: '密码'
  },
  message: {
    operationSuccess: '操作成功',
    operationFailed: '操作失败'
  }
}
```

**index.js示例**
```javascript
import Vue from 'vue';
import VueI18n from 'vue-i18n';
import zhCN from './locales/zh-CN';
import enUS from './locales/en-US';

Vue.use(VueI18n);

const i18n = new VueI18n({
  locale: 'zh-CN',
  fallbackLocale: 'zh-CN',
  messages: {
    'zh-CN': zhCN,
    'en-US': enUS
  }
});

export default i18n;
```

#### 7.1.3 自动导入i18n模块

**main.js自动注入**
```javascript
// 在main.js中自动添加
import i18n from './i18n';

new Vue({
  i18n,  // 自动注入
  // ...其他配置
}).$mount('#app');
```

**组件中自动导入**
- 检测文件是否已导入i18n
- 对于JS文件自动添加 `import i18n from '@/i18n'`
- 对于Vue组件自动使用 `this.$t()` 方法

#### 7.1.4 Key值生成规则

**自动生成策略**
```javascript
// 规则1: 根据文件路径和语义生成
'src/views/user/List.vue' + '用户管理' 
  → 'user.userManagement'

// 规则2: 根据上下文智能推断
<button>提交</button> → 'common.submit'
<h1>用户管理</h1> → 'user.userManagement'

// 规则3: 相同文本复用key
所有"提交"按钮 → 统一使用 'common.submit'
```

**手动映射配置**
```json
{
  "keyMappings": {
    "用户管理": "user.userManagement",
    "提交": "common.submit",
    "取消": "common.cancel"
  },
  "keyPrefixes": {
    "src/views/user/": "user.",
    "src/views/admin/": "admin.",
    "src/components/common/": "common."
  }
}
```

#### 7.1.5 模板字符串转换

**转换示例**
```javascript
// 替换前
const msg = `欢迎${username}登录`;
const info = `共${total}条记录`;

// 替换后
const msg = this.$t('welcomeLogin', { username });
const info = this.$t('totalRecords', { total });
```

**配置文件**
```javascript
{
  welcomeLogin: '欢迎{username}登录',
  totalRecords: '共{total}条记录'
}
```

#### 7.1.6 执行流程

1. **准备阶段**
   - 读取提取的JSON文件
   - 加载key映射配置
   - 创建备份目录

2. **生成阶段**
   - 生成i18n目录结构
   - 创建语言包文件(zh-CN.js)
   - 生成index.js初始化文件

3. **替换阶段**
   - 遍历需要替换的文件
   - 根据文件类型选择替换策略
   - 执行AST级别的精确替换
   - 处理导入语句

4. **验证阶段**
   - 检查语法错误
   - 验证key值完整性
   - 生成替换报告

#### 7.1.7 安全措施

- 替换前自动备份原文件
- 支持预览模式(不实际修改文件)
- 生成详细的替换日志
- 支持回滚操作

#### 7.1.8 配置选项

```json
{
  "autoReplace": {
    "enabled": true,
    "backup": true,
    "backupDir": "./backup",
    "preview": false,
    "i18nPath": "./src/i18n",
    "importPath": "@/i18n",
    "generateEnglish": false,
    "keyStrategy": "semantic",
    "commonKeys": ["common.submit", "common.cancel"]
  }
}
```

### 7.2 增量更新
- 支持只处理变更文件
- 维护已处理文件清单

### 7.3 多语言支持
- 集成翻译API
- 自动生成多语言配置文件

### 7.4 可视化界面
- Web界面展示提取结果
- 在线编辑和预览
- 批量操作功能

## 8. 技术栈

- **Node.js**: 运行环境
- **vue-template-compiler**: Vue 2 单文件组件解析
- **@babel/parser**: JavaScript/TypeScript解析
- **@babel/traverse**: AST遍历
- **@babel/generator**: 代码生成
- **commander**: 命令行接口

## 9. 版本支持

本工具专为 Vue 2 项目设计：
- 支持 Vue 2.x 版本
- 使用 vue-i18n@8.x
- 仅支持选项式 API (Options API)
- 组件中使用 `this.$t()` 进行国际化调用

